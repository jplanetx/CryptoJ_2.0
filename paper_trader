import time
import pandas as pd
import requests
import curses

class MarketDataHandler:
    def __init__(self, trading_pair="BTC-USD"):
            self.trading_pair = trading_pair
                    self.api_url = f"https://api.coinbase.com/v2/prices/{trading_pair}/spot"

                        def get_price(self):
                                try:
                                            response = requests.get(self.api_url)
                                                        data = response.json()
                                                                    return float(data["data"]["amount"])
                                                                            except Exception as e:
                                                                                        return None


                                                                                        class TradeEngine:
                                                                                            def __init__(self):
                                                                                                    self.prices = []

                                                                                                        def update_price(self, price):
                                                                                                                self.prices.append(price)
                                                                                                                        if len(self.prices) > 50:
                                                                                                                                    self.prices.pop(0)

                                                                                                                                        def generate_signal(self):
                                                                                                                                                if len(self.prices) < 10:
                                                                                                                                                            return "HOLD"
                                                                                                                                                                    
                                                                                                                                                                            short_ema = sum(self.prices[-10:]) / 10
                                                                                                                                                                                    long_ema = sum(self.prices[-30:]) / 30

                                                                                                                                                                                            if short_ema > long_ema:
                                                                                                                                                                                                        return "BUY"
                                                                                                                                                                                                                elif short_ema < long_ema:
                                                                                                                                                                                                                            return "SELL"
                                                                                                                                                                                                                                    else:
                                                                                                                                                                                                                                                return "HOLD"


                                                                                                                                                                                                                                                class PaperTradeSimulator:
                                                                                                                                                                                                                                                    def __init__(self, initial_balance=230):
                                                                                                                                                                                                                                                            self.balance = initial_balance
                                                                                                                                                                                                                                                                    self.holdings = 0
                                                                                                                                                                                                                                                                            self.trade_history = []
                                                                                                                                                                                                                                                                                    self.wins = 0
                                                                                                                                                                                                                                                                                            self.losses = 0

                                                                                                                                                                                                                                                                                                def execute_trade(self, signal, price):
                                                                                                                                                                                                                                                                                                        if signal == "BUY" and self.balance > 0:
                                                                                                                                                                                                                                                                                                                    allocation = self.balance * 0.75  
                                                                                                                                                                                                                                                                                                                                self.holdings = allocation / price
                                                                                                                                                                                                                                                                                                                                            self.balance -= allocation
                                                                                                                                                                                                                                                                                                                                                        self.trade_history.append(("BUY", price, self.holdings, self.balance))
                                                                                                                                                                                                                                                                                                                                                                    return f"BUY executed at {price:.2f}, Holdings: {self.holdings:.6f} BTC"

                                                                                                                                                                                                                                                                                                                                                                            elif signal == "SELL" and self.holdings > 0:
                                                                                                                                                                                                                                                                                                                                                                                        proceeds = self.holdings * price
                                                                                                                                                                                                                                                                                                                                                                                                    profit = proceeds - (self.balance * 0.75)  # Profit Calculation
                                                                                                                                                                                                                                                                                                                                                                                                                self.balance += proceeds
                                                                                                                                                                                                                                                                                                                                                                                                                            self.trade_history.append(("SELL", price, proceeds, self.balance, profit))

                                                                                                                                                                                                                                                                                                                                                                                                                                        if profit > 0:
                                                                                                                                                                                                                                                                                                                                                                                                                                                        self.wins += 1
                                                                                                                                                                                                                                                                                                                                                                                                                                                                    else:
                                                                                                                                                                                                                                                                                                                                                                                                                                                                                    self.losses += 1

                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                self.holdings = 0
                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                            return f"SELL executed at {price:.2f}, Profit: ${profit:.2f}, New Balance: ${self.balance:.2f}"
                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                    return "No trade executed"

                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                        def get_balance(self):
                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                return self.balance

                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                    def get_trade_summary(self):
                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                            return self.wins, self.losses, len(self.trade_history)


                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                            def trade_dashboard(stdscr, market, strategy, simulator):
                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                curses.curs_set(0)
                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                    stdscr.nodelay(1)
                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                        stdscr.timeout(1000)

                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                            while True:
                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                    stdscr.clear()
                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                            price = market.get_price()
                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                    if price:
                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                strategy.update_price(price)
                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                            signal = strategy.generate_signal()
                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                        trade_message = simulator.execute_trade(signal, price)

                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                # Draw UI
                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                        stdscr.addstr(1, 2, "Crypto Paper Trading Bot", curses.A_BOLD)
                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                stdscr.addstr(3, 2, f"Current Price: ${price:.2f}")
                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                        stdscr.addstr(4, 2, f"Balance: ${simulator.get_balance():.2f}")
                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                stdscr.addstr(5, 2, f"Holdings: {simulator.holdings:.6f} BTC")
                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                        
                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                # Performance Summary
                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                        wins, losses, total_trades = simulator.get_trade_summary()
                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                stdscr.addstr(7, 2, "Performance Summary:")
                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                        stdscr.addstr(8, 2, f"Total Trades: {total_trades}")
                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                stdscr.addstr(9, 2, f"Wins: {wins} | Losses: {losses}")
                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                        if total_trades > 0:
                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                    win_rate = (wins / total_trades) * 100
                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                stdscr.addstr(10, 2, f"Win Rate: {win_rate:.2f}%")
                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                        
                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                # Recent Trades
                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                        stdscr.addstr(12, 2, "Last 5 Trades:")
                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                for idx, trade in enumerate(simulator.trade_history[-5:]):
                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                            stdscr.addstr(13 + idx, 2, f"{trade[0]} @ {trade[1]:.2f} | Balance: ${trade[3]:.2f}")

                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                    # Trade Status
                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                            stdscr.addstr(19, 2, f"Last Trade: {trade_message}")

                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                    stdscr.refresh()
                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                            time.sleep(5)

                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                    if stdscr.getch() == ord("q"):
                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                break


                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                # Initialize bot components
                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                market = MarketDataHandler()
                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                strategy = TradeEngine()
                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                simulator = PaperTradeSimulator()

                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                # Start Terminal UI
                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                curses.wrapper(trade_dashboard, market, strategy, simulator)